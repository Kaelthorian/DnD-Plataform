<!doctype html>
  <html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DnD Plataform</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f4f1ea;
        --fg: #2b1f17;
        --accent: #b84a2d;
        --panel: #fff7ee;
        --line: #2b1f17;
        --muted: #6b584a;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Georgia", "Times New Roman", serif;
        background:
          radial-gradient(circle at 15% 10%, #fdf6ea 0%, transparent 45%),
          radial-gradient(circle at 85% 5%, #f7e6d1 0%, transparent 50%),
          var(--bg);
        color: var(--fg);
      }
      .page {
        max-width: 1200px;
        margin: 24px auto 60px;
        padding: 0 16px 32px;
      }
      .title {
        text-align: center;
        font-size: clamp(2rem, 3vw, 2.8rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        margin: 8px 0 18px;
      }
      .layout {
        display: grid;
        grid-template-columns: minmax(0, 3fr) minmax(0, 1fr);
        gap: 18px;
        align-items: start;
      }
      .sheet {
        background: var(--panel);
        border: 2px solid var(--line);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 18px 40px rgba(43, 31, 23, 0.18);
      }
      .sheet-grid {
        display: grid;
        grid-template-columns: 1fr 1.2fr;
        justify-content: center;
        gap: 16px;
      }
      .header-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }
      .panel {
        position: relative;
        border: 2px solid var(--line);
        border-radius: 14px;
        padding: 10px;
        background: #fff;
      }
      .panel-label {
        position: absolute;
        top: -12px;
        left: 12px;
        padding: 2px 8px;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 999px;
      }
      .panel input,
      .panel textarea,
      .panel select {
        width: 100%;
        border: 1px solid #cdbba8;
        border-radius: 8px;
        padding: 6px 8px;
        font-family: inherit;
        font-size: 0.98rem;
        background: #fff;
      }
      .panel input[readonly] {
        background: #f6f1e8;
        color: #4b3a2f;
      }
      textarea {
        min-height: 110px;
        resize: vertical;
      }
      .abilities {
        display: grid;
        gap: 10px;
      }
      .ability {
        border: 2px solid var(--line);
        border-radius: 16px;
        padding: 8px;
        background: #fff;
        text-align: center;
        width: 180px;
        margin: 0 auto;
      }
      .ability h3 {
        margin: 0 0 8px;
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      .ability .ability-row {
        display: grid;
        grid-template-rows: auto auto;
        gap: 6px;
        justify-items: center;
      }
      .ability input {
        text-align: center;
        font-size: 1.05rem;
      }
      .ability input[type="number"] {
        width: 64px;
      }
      .ability input[readonly] {
        width: 40px;
      }
      .rollable {
        cursor: pointer;
      }
      .rollable:hover {
        text-decoration: underline;
      }
      .list {
        display: grid;
        gap: 8px;
      }
      .list-item {
        display: grid;
        grid-template-columns: 18px 1fr 70px;
        align-items: center;
        gap: 8px;
      }
      .list-item input[type="number"],
      .list-item input[type="text"] {
        width: 58px;
        text-align: center;
        padding: 4px 4px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      .small-input {
        text-align: center;
      }
      .section-stack {
        display: grid;
        gap: 12px;
      }
      }
      .dice-panel {
        position: fixed;
        left: 16px;
        bottom: 16px;
        width: min(320px, 90vw);
        z-index: 999;
        background: #fff;
        border: 2px solid var(--line);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 24px rgba(43, 31, 23, 0.15);
      }
      .sticky-roll {
        position: fixed;
        left: 16px;
        bottom: 16px;
        z-index: 1000;
        padding: 10px 14px;
        border: 2px solid var(--line);
        border-radius: 12px;
        background: #fff;
        font-size: 0.95rem;
        box-shadow: 0 10px 20px rgba(43, 31, 23, 0.15);
      }
      .sticky-roll-title {
        margin: 0 0 8px;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
      }
      .dice-title {
        margin: 0 0 12px;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
      }
      #roll-btn {
        padding: 10px 18px;
        font-size: 1rem;
        font-family: inherit;
        border-radius: 12px;
        border: 2px solid var(--line);
        background: var(--accent);
        color: #fff;
        cursor: pointer;
      }
      #roll-result {
        margin-top: 10px;
        font-size: 1rem;
        display: grid;
        gap: 6px;
      }
      .roll-line {
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }
      .roll-total {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid #cdbba8;
        font-weight: 700;
        text-align: right;
      }
      .actions {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .actions select,
      .actions button {
        padding: 6px 10px;
        border-radius: 10px;
        border: 2px solid var(--line);
        font-family: inherit;
        background: #fff;
      }
      .actions .active-weapon {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .actions .equip-status {
        font-size: 0.85rem;
        color: var(--accent);
      }
      #add-weapon {
        background: var(--accent);
        color: #fff;
        cursor: pointer;
      }
      #attack-roll {
        background: #2f3a4a;
        color: #fff;
        cursor: pointer;
      }
      .hit-option {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
        color: var(--muted);
      }
      #equipment-list {
        display: grid;
        gap: 6px;
      }
      .equipment-item {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border: 1px solid #cdbba8;
        border-radius: 8px;
        background: #fff;
      }
      .equipment-item.active {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(184, 74, 45, 0.15);
      }
      .equip-btn {
        padding: 4px 8px;
        border-radius: 8px;
        border: 2px solid var(--line);
        background: #c23a2b;
        color: #fff;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .equip-btn.equipped {
        background: #2b63c2;
      }
      .equip-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #f6f1e8;
        font-size: 0.75rem;
        color: var(--muted);
      }
      .twohand-btn {
        padding: 4px 8px;
        border-radius: 8px;
        border: 2px solid var(--line);
        background: #f1efe7;
        color: var(--fg);
        cursor: pointer;
        font-size: 0.8rem;
      }
      .twohand-btn.active {
        background: #2b63c2;
        color: #fff;
      }
      .twohand-btn[disabled] {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .equipment-dmg {
        padding: 4px 8px;
        border-radius: 8px;
        border: 2px solid var(--line);
        background: #f6f1e8;
        cursor: pointer;
      }
      .item-panel {
        position: fixed;
        right: 16px;
        top: 16px;
        width: min(360px, 92vw);
        max-height: calc(100vh - 32px);
        overflow: auto;
        z-index: 1001;
        background: #fff;
        border: 2px solid var(--line);
        border-radius: 16px;
        padding: 16px 16px 18px;
        box-shadow: 0 16px 30px rgba(43, 31, 23, 0.2);
        display: none;
      }
      .item-panel.open {
        display: block;
      }
      .item-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      .item-panel-title {
        margin: 0;
        font-size: 1.1rem;
      }
      .item-panel-close {
        border: 2px solid var(--line);
        background: #fff;
        width: 32px;
        height: 32px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
      }
      .item-panel-close:hover {
        background: #f6f1e8;
      }
      .item-panel-body {
        display: grid;
        gap: 8px;
        color: var(--fg);
      }
      .item-row {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 8px;
        align-items: baseline;
        font-size: 0.95rem;
      }
      .item-row strong {
        font-weight: 700;
        color: var(--muted);
      }
      .item-tooltip {
        position: relative;
        cursor: help;
      }
      .item-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 0;
        top: 100%;
        margin-top: 6px;
        min-width: 160px;
        max-width: 280px;
        padding: 8px 10px;
        border-radius: 10px;
        background: #1f1711;
        color: #fff7ee;
        font-size: 0.82rem;
        line-height: 1.25;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        opacity: 0;
        pointer-events: none;
        transform: translateY(-4px);
        transition: opacity 0.15s ease, transform 0.15s ease;
        z-index: 5;
        white-space: normal;
      }
      .item-tooltip:hover::after {
        opacity: 1;
        transform: translateY(0);
      }
      .weapon-picker {
        position: fixed;
        left: 16px;
        top: 16px;
        width: min(360px, 92vw);
        max-height: calc(100vh - 32px);
        overflow: auto;
        z-index: 1002;
        background: #fff;
        border: 2px solid var(--line);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 16px 30px rgba(43, 31, 23, 0.2);
        display: none;
      }
      .weapon-picker.open {
        display: block;
      }
      .weapon-picker-header {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
      }
      .weapon-picker-header input {
        width: 100%;
        border: 1px solid #cdbba8;
        border-radius: 10px;
        padding: 6px 10px;
        font-family: inherit;
      }
      .weapon-picker-add,
      .weapon-picker-close {
        border-radius: 10px;
        border: 2px solid var(--line);
        padding: 6px 12px;
        font-family: inherit;
        cursor: pointer;
      }
      .weapon-picker-add {
        background: var(--accent);
        color: #fff;
      }
      .weapon-picker-close {
        background: #fff;
      }
      .weapon-category {
        margin: 10px 0 6px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }
      .weapon-list {
        display: grid;
        gap: 6px;
      }
      .weapon-option {
        border: 1px solid #cdbba8;
        border-radius: 10px;
        padding: 8px 10px;
        cursor: pointer;
        background: #fff;
      }
      .weapon-option strong {
        display: block;
        font-size: 0.95rem;
      }
      .weapon-option span {
        font-size: 0.82rem;
        color: var(--muted);
      }
      .weapon-option.selected {
        border-color: var(--accent);
        background: #fff4ec;
      }
      @media (max-width: 960px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .header-grid {
          grid-template-columns: 1fr;
        }
        .sheet-grid {
          grid-template-columns: 1fr;
        }
        .stats-grid {
          grid-template-columns: 1fr;
        }
        .dice-panel {
          left: 12px;
          bottom: 12px;
          width: min(360px, 94vw);
        }
        .item-panel {
          right: 12px;
          top: 12px;
        }
        .weapon-picker {
          left: 12px;
          top: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="title">DnD Plataform</div>
      <div class="layout">
        <section class="sheet" aria-label="Character Sheet">
          <div class="header-grid">
            <div class="panel">
              <div class="panel-label">Character Name</div>
              <input id="character-name" type="text" />
            </div>
            <div class="panel">
              <div class="panel-label">Class</div>
              <input id="class-level" type="text" />
            </div>
            <div class="panel">
              <div class="panel-label">Level</div>
              <input id="level" type="number" min="1" max="20" />
            </div>
            <div class="panel">
              <div class="panel-label">Background</div>
              <input id="background" type="text" />
            </div>
            <div class="panel">
              <div class="panel-label">Player Name</div>
              <input id="player-name" type="text" />
            </div>
            <div class="panel">
              <div class="panel-label">Race</div>
              <input id="race" type="text" />
            </div>
            <div class="panel">
              <div class="panel-label">Alignment</div>
              <input id="alignment" type="text" />
            </div>
            <div class="panel">
              <div class="panel-label">EXP</div>
              <input id="xp" type="number" min="0" />
            </div>
            <div class="panel">
              <div class="panel-label">Inspiration</div>
              <input id="inspiration" type="text" />
            </div>
            <div class="panel">
              <div class="panel-label">Proficiency Bonus</div>
              <input id="proficiency-bonus" type="text" readonly />
            </div>
          </div>

          <div class="sheet-grid">
            <div class="section-stack">
              <div class="abilities">
                <div class="ability" data-ability="str">
                  <h3>Strength</h3>
                  <div class="ability-row">
                    <input id="str-score" type="number" min="1" max="30" placeholder="Score" />
                    <input id="str-mod" type="text" placeholder="Mod" readonly />
                  </div>
                </div>
                <div class="ability" data-ability="dex">
                  <h3>Dexterity</h3>
                  <div class="ability-row">
                    <input id="dex-score" type="number" min="1" max="30" placeholder="Score" />
                    <input id="dex-mod" type="text" placeholder="Mod" readonly />
                  </div>
                </div>
                <div class="ability" data-ability="con">
                  <h3>Constitution</h3>
                  <div class="ability-row">
                    <input id="con-score" type="number" min="1" max="30" placeholder="Score" />
                    <input id="con-mod" type="text" placeholder="Mod" readonly />
                  </div>
                </div>
                <div class="ability" data-ability="int">
                  <h3>Intelligence</h3>
                  <div class="ability-row">
                    <input id="int-score" type="number" min="1" max="30" placeholder="Score" />
                    <input id="int-mod" type="text" placeholder="Mod" readonly />
                  </div>
                </div>
                <div class="ability" data-ability="wis">
                  <h3>Wisdom</h3>
                  <div class="ability-row">
                    <input id="wis-score" type="number" min="1" max="30" placeholder="Score" />
                    <input id="wis-mod" type="text" placeholder="Mod" readonly />
                  </div>
                </div>
                <div class="ability" data-ability="cha">
                  <h3>Charisma</h3>
                  <div class="ability-row">
                    <input id="cha-score" type="number" min="1" max="30" placeholder="Score" />
                    <input id="cha-mod" type="text" placeholder="Mod" readonly />
                  </div>
                </div>
              </div>

              <div class="panel">
                <div class="panel-label">Saving Throws</div>
                <div class="list">
                  <div class="list-item" data-ability="str"><input id="save-str-prof" type="checkbox" /><span>Strength</span><input class="save-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="dex"><input id="save-dex-prof" type="checkbox" /><span>Dexterity</span><input class="save-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="con"><input id="save-con-prof" type="checkbox" /><span>Constitution</span><input class="save-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="int"><input id="save-int-prof" type="checkbox" /><span>Intelligence</span><input class="save-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="wis"><input id="save-wis-prof" type="checkbox" /><span>Wisdom</span><input class="save-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="cha"><input id="save-cha-prof" type="checkbox" /><span>Charisma</span><input class="save-value" type="text" readonly /></div>
                </div>
              </div>

              <div class="panel">
                <div class="panel-label">Skills</div>
                <div class="list">
                  <div class="list-item" data-ability="dex"><input id="skill-acrobatics-prof" type="checkbox" /><span>Acrobatics (Dex)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="wis"><input id="skill-animal-handling-prof" type="checkbox" /><span>Animal Handling (Wis)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="int"><input id="skill-arcana-prof" type="checkbox" /><span>Arcana (Int)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="str"><input id="skill-athletics-prof" type="checkbox" /><span>Athletics (Str)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="cha"><input id="skill-deception-prof" type="checkbox" /><span>Deception (Cha)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="int"><input id="skill-history-prof" type="checkbox" /><span>History (Int)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="wis"><input id="skill-insight-prof" type="checkbox" /><span>Insight (Wis)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="cha"><input id="skill-intimidation-prof" type="checkbox" /><span>Intimidation (Cha)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="int"><input id="skill-investigation-prof" type="checkbox" /><span>Investigation (Int)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="wis"><input id="skill-medicine-prof" type="checkbox" /><span>Medicine (Wis)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="int"><input id="skill-nature-prof" type="checkbox" /><span>Nature (Int)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="wis"><input id="skill-perception-prof" type="checkbox" /><span>Perception (Wis)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="cha"><input id="skill-performance-prof" type="checkbox" /><span>Performance (Cha)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="cha"><input id="skill-persuasion-prof" type="checkbox" /><span>Persuasion (Cha)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="int"><input id="skill-religion-prof" type="checkbox" /><span>Religion (Int)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="dex"><input id="skill-sleight-of-hand-prof" type="checkbox" /><span>Sleight of Hand (Dex)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="dex"><input id="skill-stealth-prof" type="checkbox" /><span>Stealth (Dex)</span><input class="skill-value" type="text" readonly /></div>
                  <div class="list-item" data-ability="wis"><input id="skill-survival-prof" type="checkbox" /><span>Survival (Wis)</span><input class="skill-value" type="text" readonly /></div>
                </div>
              </div>

              <div class="panel">
                <div class="panel-label">Passive Wisdom (Perception)</div>
                <input id="passive-perception" class="small-input" type="number" min="0" readonly />
              </div>
            </div>

            <div class="section-stack">
              <div class="panel">
                <div class="panel-label">Combat</div>
                <div class="stats-grid">
                  <div>
                    <label for="ac">Armor Class</label>
                    <input id="ac" class="small-input" type="number" min="0" />
                  </div>
                  <div>
                    <label for="initiative">Initiative</label>
                    <input id="initiative" class="small-input" type="text" />
                  </div>
                  <div>
                    <label for="speed">Speed</label>
                    <input id="speed" class="small-input" type="text" />
                  </div>
                </div>
              </div>

              <div class="panel">
                <div class="panel-label">Hit Points</div>
                <label for="hp-max">Hit Point Maximum</label>
                <input id="hp-max" type="number" min="0" />
                <label for="hp-current">Current Hit Points</label>
                <input id="hp-current" type="number" min="0" />
                <label for="hp-temp">Temporary Hit Points</label>
                <input id="hp-temp" type="number" min="0" />
              </div>

              <div class="panel">
                <div class="panel-label">Hit Dice & Death Saves</div>
                <label for="hit-dice">Hit Dice</label>
                <input id="hit-dice" type="text" />
                <label for="death-saves">Death Saves (Success/Fail)</label>
                <input id="death-saves" type="text" />
              </div>

              <div class="panel">
                <div class="panel-label">Attacks & Spellcasting</div>
                <textarea id="attacks"></textarea>
              </div>

              <div class="panel">
              <div class="panel-label">Equipment</div>
              <div class="actions" style="margin-bottom: 8px;">
                <button id="attack-roll" type="button">Hit</button>
                <label class="hit-option">
                  <input id="attack-prof" type="checkbox" data-nosave="true" checked />
                  Proficient
                </label>
                <button id="add-weapon" type="button">Add Weapon</button>
                <span class="active-weapon" id="active-weapon-label">No weapon selected</span>
                <span class="equip-status" id="equip-status"></span>
              </div>
              <div id="equipment-list"></div>
            </div>
            </div>

          </div>
        </section>
      </div>
    </div>
    <aside class="sticky-roll" aria-live="polite">
      <div class="sticky-roll-title">Dice Roll</div>
      <div id="roll-result">No rolls yet.</div>
    </aside>
    <aside class="item-panel" id="item-panel" aria-live="polite" aria-label="Item details">
      <div class="item-panel-header">
        <h2 class="item-panel-title" id="item-panel-title">Item</h2>
        <button class="item-panel-close" id="item-panel-close" type="button" aria-label="Close item details">✕</button>
      </div>
      <div class="item-panel-body" id="item-panel-body"></div>
    </aside>
    <aside class="weapon-picker" id="weapon-picker" aria-live="polite" aria-label="Weapon picker" aria-hidden="true">
      <div class="weapon-picker-header">
        <input id="weapon-search" type="search" placeholder="Search weapons..." />
        <button id="weapon-picker-add" class="weapon-picker-add" type="button" disabled>Add</button>
        <button id="weapon-picker-close" class="weapon-picker-close" type="button">X</button>
      </div>
      <div id="weapon-picker-list"></div>
    </aside>
    <aside class="weapon-picker race-picker" id="race-picker" aria-live="polite" aria-label="Race picker" aria-hidden="true">
      <div class="weapon-picker-header">
        <input id="race-search" type="search" placeholder="Search races..." />
        <button id="race-picker-add" class="weapon-picker-add" type="button" disabled>Add</button>
        <button id="race-picker-close" class="weapon-picker-close" type="button">X</button>
      </div>
      <div id="race-picker-list"></div>
    </aside>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
      import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAA4Ak_mKs67_b2LIxjSQ0TabAIa5JE4rA",
        authDomain: "dnd-dice-ca4b0.firebaseapp.com",
        projectId: "dnd-dice-ca4b0",
        storageBucket: "dnd-dice-ca4b0.firebasestorage.app",
        messagingSenderId: "338841368755",
        appId: "1:338841368755:web:80065ec73a88b9e2ba58c6",
        measurementId: "G-VPGSM8BFR6",
      };

      const app = initializeApp(firebaseConfig);
      getAnalytics(app);
      const db = getFirestore(app);

      const rollRef = doc(db, "dice", "d20");
      const sheetRef = doc(db, "sheets", "active");
      const resultEl = document.getElementById("roll-result");
      const rollBtn = document.getElementById("roll-btn");
      const raceInput = document.getElementById("race");
      const fieldEls = Array.from(
        document.querySelectorAll(
          "input[id]:not([data-nosave]), textarea[id]:not([data-nosave]), select[id]:not([data-nosave])"
        )
      );
      const abilityScores = {
        str: document.getElementById("str-score"),
        dex: document.getElementById("dex-score"),
        con: document.getElementById("con-score"),
        int: document.getElementById("int-score"),
        wis: document.getElementById("wis-score"),
        cha: document.getElementById("cha-score"),
      };
      const abilityMods = {
        str: document.getElementById("str-mod"),
        dex: document.getElementById("dex-mod"),
        con: document.getElementById("con-mod"),
        int: document.getElementById("int-mod"),
        wis: document.getElementById("wis-mod"),
        cha: document.getElementById("cha-mod"),
      };
      const proficiencyBonusEl = document.getElementById("proficiency-bonus");
      const levelEl = document.getElementById("level");
      const passivePerceptionEl = document.getElementById("passive-perception");
      const saveRows = Array.from(document.querySelectorAll(".list-item[data-ability]"))
        .filter((row) => row.querySelector(".save-value"));
      const skillRows = Array.from(document.querySelectorAll(".list-item[data-ability]"))
        .filter((row) => row.querySelector(".skill-value"));
      const attackRollBtn = document.getElementById("attack-roll");
      const attackProfEl = document.getElementById("attack-prof");
      const addWeaponBtn = document.getElementById("add-weapon");
      const activeWeaponLabel = document.getElementById("active-weapon-label");
      const equipStatusEl = document.getElementById("equip-status");
      const weaponPicker = document.getElementById("weapon-picker");
      const weaponPickerList = document.getElementById("weapon-picker-list");
      const weaponSearch = document.getElementById("weapon-search");
      const weaponPickerAdd = document.getElementById("weapon-picker-add");
      const weaponPickerClose = document.getElementById("weapon-picker-close");
      const racePicker = document.getElementById("race-picker");
      const racePickerList = document.getElementById("race-picker-list");
      const raceSearch = document.getElementById("race-search");
      const racePickerAdd = document.getElementById("race-picker-add");
      const racePickerClose = document.getElementById("race-picker-close");
      const itemPanel = document.getElementById("item-panel");
      const itemPanelTitle = document.getElementById("item-panel-title");
      const itemPanelBody = document.getElementById("item-panel-body");
      const itemPanelClose = document.getElementById("item-panel-close");
      const equipmentListEl = document.getElementById("equipment-list");
      let equipmentItems = [];
      let activeWeaponName = "";
      let pickerSelected = "";
      let raceSelected = "";
      let equippedMainId = "";
      let equippedOffhandId = "";
      let equippedMainTwoHanded = false;
      let isRemoteUpdate = false;
      let saveTimer = null;

      function toNumber(value) {
        const num = Number(value);
        return Number.isFinite(num) ? num : 0;
      }

      function formatMod(num) {
        if (!Number.isFinite(num)) return "";
        return num >= 0 ? `+${num}` : `${num}`;
      }

      function computeAbilityMod(score) {
        if (!Number.isFinite(score)) return 0;
        return Math.floor((score - 10) / 2);
      }

      function getFieldValue(el) {
        if (el.type === "checkbox") {
          return el.checked;
        }
        return el.value;
      }

      function applyFieldValue(el, value) {
        if (value === undefined) return;
        if (el.type === "checkbox") {
          el.checked = Boolean(value);
          return;
        }
        el.value = value;
      }

      const proficiencyByLevel = [
        2, 2, 2, 2,
        3, 3, 3, 3,
        4, 4, 4, 4,
        5, 5, 5, 5,
        6, 6, 6, 6,
      ];

      function recalcDerived() {
        const levelRaw = toNumber(levelEl?.value);
        const level = Math.min(Math.max(levelRaw || 1, 1), 20);
        const profBonus = proficiencyByLevel[level - 1] ?? 2;
        if (proficiencyBonusEl) {
          proficiencyBonusEl.value = formatMod(profBonus);
        }
        const mods = {};
        Object.entries(abilityScores).forEach(([ability, scoreEl]) => {
          const score = toNumber(scoreEl?.value);
          const mod = computeAbilityMod(score);
          mods[ability] = mod;
          if (abilityMods[ability]) {
            abilityMods[ability].value = formatMod(mod);
          }
        });

        saveRows.forEach((row) => {
          const ability = row.dataset.ability;
          const checkbox = row.querySelector("input[type='checkbox']");
          const valueEl = row.querySelector(".save-value");
          const base = mods[ability] ?? 0;
          const total = base + (checkbox?.checked ? profBonus : 0);
          valueEl.value = formatMod(total);
        });

        skillRows.forEach((row) => {
          const ability = row.dataset.ability;
          const checkbox = row.querySelector("input[type='checkbox']");
          const valueEl = row.querySelector(".skill-value");
          const base = mods[ability] ?? 0;
          const total = base + (checkbox?.checked ? profBonus : 0);
          valueEl.value = formatMod(total);
        });

        if (passivePerceptionEl) {
          const perceptionRow = skillRows.find(
            (row) => row.textContent && row.textContent.includes("Perception")
          );
          const perceptionValueEl = perceptionRow?.querySelector(".skill-value");
          const perceptionMod = toNumber(perceptionValueEl?.value);
          passivePerceptionEl.value = String(10 + perceptionMod);
        }

        if (!isRemoteUpdate) {
          scheduleSave();
        }
      }

      const weaponTable = [
        { name: "Club", damage: "1d4 Bludgeoning", properties: "Light", mastery: "Slow", weight: "2 lb.", cost: "1 SP", category: "Simple Melee Weapons" },
        { name: "Dagger", damage: "1d4 Piercing", properties: "Finesse, Light, Thrown (Range 20/60)", mastery: "Nick", weight: "1 lb.", cost: "2 GP", category: "Simple Melee Weapons" },
        { name: "Greatclub", damage: "1d8 Bludgeoning", properties: "Two-Handed", mastery: "Push", weight: "10 lb.", cost: "2 SP", category: "Simple Melee Weapons" },
        { name: "Handaxe", damage: "1d6 Slashing", properties: "Light, Thrown (Range 20/60)", mastery: "Vex", weight: "2 lb.", cost: "5 GP", category: "Simple Melee Weapons" },
        { name: "Javelin", damage: "1d6 Piercing", properties: "Thrown (Range 30/120)", mastery: "Slow", weight: "2 lb.", cost: "5 SP", category: "Simple Melee Weapons" },
        { name: "Light Hammer", damage: "1d4 Bludgeoning", properties: "Light, Thrown (Range 20/60)", mastery: "Nick", weight: "2 lb.", cost: "2 GP", category: "Simple Melee Weapons" },
        { name: "Mace", damage: "1d6 Bludgeoning", properties: "—", mastery: "Sap", weight: "4 lb.", cost: "5 GP", category: "Simple Melee Weapons" },
        { name: "Quarterstaff", damage: "1d6 Bludgeoning", properties: "Versatile (1d8)", mastery: "Topple", weight: "4 lb.", cost: "2 SP", category: "Simple Melee Weapons" },
        { name: "Sickle", damage: "1d4 Slashing", properties: "Light", mastery: "Nick", weight: "2 lb.", cost: "1 GP", category: "Simple Melee Weapons" },
        { name: "Spear", damage: "1d6 Piercing", properties: "Thrown (Range 20/60), Versatile (1d8)", mastery: "Sap", weight: "3 lb.", cost: "1 GP", category: "Simple Melee Weapons" },
        { name: "Dart", damage: "1d4 Piercing", properties: "Finesse, Thrown (Range 20/60)", mastery: "Vex", weight: "1/4 lb.", cost: "5 CP", category: "Simple Ranged Weapons" },
        { name: "Light Crossbow", damage: "1d8 Piercing", properties: "Ammunition (Range 80/320; Bolt), Loading, Two-Handed", mastery: "Slow", weight: "5 lb.", cost: "25 GP", category: "Simple Ranged Weapons" },
        { name: "Shortbow", damage: "1d6 Piercing", properties: "Ammunition (Range 80/320; Arrow), Two-Handed", mastery: "Vex", weight: "2 lb.", cost: "25 GP", category: "Simple Ranged Weapons" },
        { name: "Sling", damage: "1d4 Bludgeoning", properties: "Ammunition (Range 30/120; Bullet)", mastery: "Slow", weight: "—", cost: "1 SP", category: "Simple Ranged Weapons" },
        { name: "Battleaxe", damage: "1d8 Slashing", properties: "Versatile (1d10)", mastery: "Topple", weight: "4 lb.", cost: "10 GP", category: "Martial Melee Weapons" },
        { name: "Flail", damage: "1d8 Bludgeoning", properties: "—", mastery: "Sap", weight: "2 lb.", cost: "10 GP", category: "Martial Melee Weapons" },
        { name: "Glaive", damage: "1d10 Slashing", properties: "Heavy, Reach, Two-Handed", mastery: "Graze", weight: "6 lb.", cost: "20 GP", category: "Martial Melee Weapons" },
        { name: "Greataxe", damage: "1d12 Slashing", properties: "Heavy, Two-Handed", mastery: "Cleave", weight: "7 lb.", cost: "30 GP", category: "Martial Melee Weapons" },
        { name: "Greatsword", damage: "2d6 Slashing", properties: "Heavy, Two-Handed", mastery: "Graze", weight: "6 lb.", cost: "50 GP", category: "Martial Melee Weapons" },
        { name: "Halberd", damage: "1d10 Slashing", properties: "Heavy, Reach, Two-Handed", mastery: "Cleave", weight: "6 lb.", cost: "20 GP", category: "Martial Melee Weapons" },
        { name: "Lance", damage: "1d10 Piercing", properties: "Heavy, Reach, Two-Handed (unless mounted)", mastery: "Topple", weight: "6 lb.", cost: "10 GP", category: "Martial Melee Weapons" },
        { name: "Longsword", damage: "1d8 Slashing", properties: "Versatile (1d10)", mastery: "Sap", weight: "3 lb.", cost: "15 GP", category: "Martial Melee Weapons" },
        { name: "Maul", damage: "2d6 Bludgeoning", properties: "Heavy, Two-Handed", mastery: "Topple", weight: "10 lb.", cost: "10 GP", category: "Martial Melee Weapons" },
        { name: "Morningstar", damage: "1d8 Piercing", properties: "—", mastery: "Sap", weight: "4 lb.", cost: "15 GP", category: "Martial Melee Weapons" },
        { name: "Pike", damage: "1d10 Piercing", properties: "Heavy, Reach, Two-Handed", mastery: "Push", weight: "18 lb.", cost: "5 GP", category: "Martial Melee Weapons" },
        { name: "Rapier", damage: "1d8 Piercing", properties: "Finesse", mastery: "Vex", weight: "2 lb.", cost: "25 GP", category: "Martial Melee Weapons" },
        { name: "Scimitar", damage: "1d6 Slashing", properties: "Finesse, Light", mastery: "Nick", weight: "3 lb.", cost: "25 GP", category: "Martial Melee Weapons" },
        { name: "Shortsword", damage: "1d6 Piercing", properties: "Finesse, Light", mastery: "Vex", weight: "2 lb.", cost: "10 GP", category: "Martial Melee Weapons" },
        { name: "Trident", damage: "1d8 Piercing", properties: "Thrown (Range 20/60), Versatile (1d10)", mastery: "Topple", weight: "4 lb.", cost: "5 GP", category: "Martial Melee Weapons" },
        { name: "Warhammer", damage: "1d8 Bludgeoning", properties: "Versatile (1d10)", mastery: "Push", weight: "5 lb.", cost: "15 GP", category: "Martial Melee Weapons" },
        { name: "War Pick", damage: "1d8 Piercing", properties: "Versatile (1d10)", mastery: "Sap", weight: "2 lb.", cost: "5 GP", category: "Martial Melee Weapons" },
        { name: "Whip", damage: "1d4 Slashing", properties: "Finesse, Reach", mastery: "Slow", weight: "3 lb.", cost: "2 GP", category: "Martial Melee Weapons" },
        { name: "Blowgun", damage: "1 Piercing", properties: "Ammunition (Range 25/100; Needle), Loading", mastery: "Vex", weight: "1 lb.", cost: "10 GP", category: "Martial Ranged Weapons" },
        { name: "Hand Crossbow", damage: "1d6 Piercing", properties: "Ammunition (Range 30/120; Bolt), Light, Loading", mastery: "Vex", weight: "3 lb.", cost: "75 GP", category: "Martial Ranged Weapons" },
        { name: "Heavy Crossbow", damage: "1d10 Piercing", properties: "Ammunition (Range 100/400; Bolt), Heavy, Loading, Two-Handed", mastery: "Push", weight: "18 lb.", cost: "50 GP", category: "Martial Ranged Weapons" },
        { name: "Longbow", damage: "1d8 Piercing", properties: "Ammunition (Range 150/600; Arrow), Heavy, Two-Handed", mastery: "Slow", weight: "2 lb.", cost: "50 GP", category: "Martial Ranged Weapons" },
        { name: "Musket", damage: "1d12 Piercing", properties: "Ammunition (Range 40/120; Bullet), Loading, Two-Handed", mastery: "Slow", weight: "10 lb.", cost: "500 GP", category: "Martial Ranged Weapons" },
        { name: "Pistol", damage: "1d10 Piercing", properties: "Ammunition (Range 30/90; Bullet), Loading", mastery: "Vex", weight: "3 lb.", cost: "250 GP", category: "Martial Ranged Weapons" },
      ];
      const weaponAliases = {
        "Crossbow, Light": "Light Crossbow",
        "Crossbow, Hand": "Hand Crossbow",
        "Crossbow, Heavy": "Heavy Crossbow",
      };
      const masteryDescriptions = {
        Cleave: "On a melee hit, you can make an extra attack vs a second creature within 5 ft and reach. No ability mod to that damage unless negative. Once per turn.",
        Graze: "On a miss, deal damage equal to the ability modifier used. Same damage type.",
        Nick: "The extra Light-weapon attack can be part of the Attack action instead of a Bonus Action. Once per turn.",
        Push: "On a hit, you can push a Large or smaller creature up to 10 ft away.",
        Sap: "On a hit, the target has disadvantage on its next attack roll before your next turn.",
        Slow: "On a hit, reduce target Speed by 10 ft until your next turn. Does not stack beyond 10 ft.",
        Topple: "On a hit, target makes a Con save (DC 8 + ability mod + prof). Fail: Prone.",
        Vex: "On a hit, you have advantage on your next attack roll vs that creature before your next turn ends.",
      };
      const propertyDescriptions = {
        Ammunition: "Requires ammo. Each attack expends one. You need a free hand to load a one-handed weapon.",
        Finesse: "Use STR or DEX for attack and damage; same mod for both.",
        Heavy: "Disadvantage on attacks if STR < 13 (melee) or DEX < 13 (ranged).",
        Light: "After attacking with a Light weapon, you can make one extra Light-weapon attack as a Bonus Action; no ability mod to that damage unless negative.",
        Loading: "You can fire only one piece of ammo per action/bonus action/reaction.",
        Range: "Normal/long range. Disadvantage beyond normal; can't attack beyond long.",
        Reach: "Adds 5 ft to your reach for attacks and opportunity attacks.",
        Thrown: "Can be thrown; draw it as part of the attack. Use the same ability mod as melee with it.",
        "Two-Handed": "Requires two hands to attack.",
        Versatile: "Use one or two hands. Parentheses show damage when used with two hands.",
      };
      const weaponByName = new Map(weaponTable.map((weapon) => [weapon.name, weapon]));
      const weaponList = weaponTable.map((weapon) => weapon.name);
      const raceList = [
        "Aasimar",
        "Dragonborn",
        "Dwarf",
        "Elf",
        "Gnome",
        "Goliath",
        "Halfling",
        "Human",
        "Dhampir",
        "Hexblood",
        "Orc",
        "Reborn",
        "Tiefling",
      ];

      function resolveWeaponName(name) {
        if (weaponByName.has(name)) return name;
        const alias = weaponAliases[name];
        return alias && weaponByName.has(alias) ? alias : name;
      }

      function getWeaponData(name) {
        const resolved = resolveWeaponName(name);
        return weaponByName.get(resolved) || null;
      }

      function getDamageDie(damage) {
        if (!damage) return "";
        return damage.split(" ")[0];
      }

      function getVersatileDie(properties) {
        if (!properties) return "";
        const match = properties.match(/Versatile\s*\\(([^)]+)\\)/i);
        if (!match) return "";
        return match[1].trim();
      }

      function isVersatileWeapon(weapon) {
        return Boolean(weapon?.properties && weapon.properties.includes("Versatile"));
      }

      function getWeaponDamageDie(weapon, useTwoHands) {
        if (!weapon) return "";
        if (useTwoHands && isVersatileWeapon(weapon)) {
          return getVersatileDie(weapon.properties) || getDamageDie(weapon.damage);
        }
        return getDamageDie(weapon.damage);
      }

      function getWeaponAttackAbility(weapon) {
        if (!weapon) return "str";
        if (weapon.properties && weapon.properties.includes("Finesse")) return "finesse";
        if (weapon.category && weapon.category.includes("Ranged")) return "dex";
        return "str";
      }

      function buildPropertiesTooltip(properties) {
        if (!properties || properties === "—") return "No properties.";
        const parts = properties.split(",").map((part) => part.trim());
        return parts
          .map((part) => {
            const base = part.split(" (")[0].trim();
            const desc = propertyDescriptions[base] || "";
            const parenMatch = part.match(/\\(([^)]+)\\)/);
            const extra = parenMatch ? ` Range: ${parenMatch[1]}.` : "";
            return desc ? `${base}: ${desc}${extra}` : part;
          })
          .join(" ");
      }

      function getItemTooltip(label, value, weapon) {
        if (label === "Mastery") {
          return masteryDescriptions[weapon.mastery] || `Mastery: ${weapon.mastery}`;
        }
        if (label === "Properties") {
          return buildPropertiesTooltip(weapon.properties);
        }
        if (label === "Range") {
          return `Range: ${value} (normal/long).`;
        }
        return `${label}: ${value}`;
      }

      function rollDiceDetailed(dice) {
        if (!dice) return 0;
        if (/^\d+$/.test(dice)) {
          const value = Number(dice);
          return { total: value, rolls: [value] };
        }
        const match = dice.match(/(\d+)d(\d+)/i);
        if (!match) return { total: 0, rolls: [] };
        const count = Number(match[1]);
        const sides = Number(match[2]);
        let total = 0;
        const rolls = [];
        for (let i = 0; i < count; i += 1) {
          const roll = Math.floor(Math.random() * sides) + 1;
          rolls.push(roll);
          total += roll;
        }
        return { total, rolls };
      }

      function rollDamage(dice, label, ability) {
        const detail = rollDiceDetailed(dice);
        const abilityKey = ability === "finesse"
          ? (toNumber(abilityMods.dex?.value) >= toNumber(abilityMods.str?.value) ? "dex" : "str")
          : ability || "str";
        const modValue = toNumber(abilityMods[abilityKey]?.value);
        const total = detail.total + modValue;
        resultEl.textContent = `Rolling... (${detail.total})`;
        return setDoc(rollRef, {
          roll: detail.total,
          mod: modValue,
          value: total,
          label,
          parts: [
            { label: dice, value: detail.total, detail: detail.rolls.join("+") },
            { label: `${abilityKey.toUpperCase()} Mod`, value: modValue },
          ],
          by: "anonymous",
          at: serverTimestamp(),
        });
      }

      function renderEquipment() {
        if (!equipmentListEl) return;
        equipmentListEl.innerHTML = "";
        equipmentItems.forEach((item) => {
          const weapon = getWeaponData(item.name);
          const displayName = weapon?.name || item.name;
          const row = document.createElement("div");
          row.className = "equipment-item";
          if (displayName === activeWeaponName) {
            row.classList.add("active");
          }
          const label = document.createElement("div");
          label.textContent = displayName;
          label.style.cursor = "pointer";
          label.addEventListener("click", () => {
            activeWeaponName = displayName;
            updateActiveWeaponLabel();
            renderEquipment();
            openItemPanel(displayName);
          });
          row.appendChild(label);
          if (item.id === equippedMainId || item.id === equippedOffhandId) {
            const badge = document.createElement("span");
            badge.className = "equip-badge";
            badge.textContent = item.id === equippedMainId ? "Main" : "Offhand";
            row.appendChild(badge);
          }
          const useTwoHands =
            item.id === equippedMainId && equippedMainTwoHanded && isVersatileWeapon(weapon);
          const dice = getWeaponDamageDie(weapon, useTwoHands);
          if (dice) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "equipment-dmg";
            btn.textContent = dice;
            btn.addEventListener("click", () => {
              const isEquipped = item.id === equippedMainId || item.id === equippedOffhandId;
              if (!isEquipped) {
                setEquipStatus("Equip this weapon before rolling damage.");
                return;
              }
              if (equippedMainTwoHanded && item.id !== equippedMainId) {
                setEquipStatus("You can't use an offhand weapon while using two hands.");
                return;
              }
              const currentWeapon = getWeaponData(item.name);
              const currentUseTwoHands =
                item.id === equippedMainId &&
                equippedMainTwoHanded &&
                isVersatileWeapon(currentWeapon);
              if (equippedMainTwoHanded && item.id === equippedMainId) {
                const isValidTwoHand =
                  isVersatileWeapon(currentWeapon) || currentWeapon?.properties.includes("Two-Handed");
                if (!isValidTwoHand) {
                  setEquipStatus("This weapon can't be used with two hands.");
                  return;
                }
              }
              const currentDice = getWeaponDamageDie(currentWeapon, currentUseTwoHands);
              activeWeaponName = displayName;
              updateActiveWeaponLabel();
              renderEquipment();
              const ability = getWeaponAttackAbility(currentWeapon);
              const labelText = `${displayName} Damage (${currentDice})`;
              rollDamage(currentDice, labelText, ability);
            });
            row.appendChild(btn);
          } else {
            const spacer = document.createElement("div");
            spacer.textContent = "";
            row.appendChild(spacer);
          }
          const equipBtn = document.createElement("button");
          equipBtn.type = "button";
          equipBtn.className = "equip-btn";
          const isEquipped = item.id === equippedMainId || item.id === equippedOffhandId;
          if (isEquipped) {
            equipBtn.classList.add("equipped");
          }
          equipBtn.textContent = isEquipped ? "Unequip" : "Equip";
          equipBtn.addEventListener("click", () => {
            handleEquipToggle(item);
          });
          row.appendChild(equipBtn);
          if (isVersatileWeapon(weapon)) {
            const twoHandBtn = document.createElement("button");
            twoHandBtn.type = "button";
            twoHandBtn.className = "twohand-btn";
            const isActive = item.id === equippedMainId && equippedMainTwoHanded;
            if (isActive) {
              twoHandBtn.classList.add("active");
            }
            twoHandBtn.textContent = "Two Hands";
            twoHandBtn.disabled = item.id !== equippedMainId;
            twoHandBtn.addEventListener("click", () => {
              handleTwoHandToggle(item);
            });
            row.appendChild(twoHandBtn);
          }
          equipmentListEl.appendChild(row);
        });
      }

      function updateActiveWeaponLabel() {
        if (!activeWeaponLabel) return;
        const mainItem = equipmentItems.find((item) => item.id === equippedMainId);
        if (mainItem) {
          activeWeaponLabel.textContent = `Equipped: ${mainItem.name}${equippedMainTwoHanded ? " (Two Hands)" : ""}`;
          updateAttackRollLabel();
          return;
        }
        activeWeaponLabel.textContent = activeWeaponName
          ? `Active: ${activeWeaponName}`
          : "No weapon selected";
        updateAttackRollLabel();
      }

      function updateAttackRollLabel() {
        if (!attackRollBtn) return;
        const mainItem = getEquippedWeaponById(equippedMainId);
        const weaponName = mainItem?.name || activeWeaponName;
        const weapon = weaponName ? getWeaponData(weaponName) : null;
        if (!weapon) {
          attackRollBtn.textContent = "Hit";
          return;
        }
        const useTwoHands =
          mainItem && mainItem.id === equippedMainId && equippedMainTwoHanded && isVersatileWeapon(weapon);
        const dice = getWeaponDamageDie(weapon, useTwoHands);
        attackRollBtn.textContent = dice ? `Hit (${dice})` : "Hit";
      }

      function setEquipStatus(message = "") {
        if (!equipStatusEl) return;
        equipStatusEl.textContent = message;
      }

      function setPickerOpen(isOpen) {
        if (!weaponPicker) return;
        weaponPicker.classList.toggle("open", isOpen);
        weaponPicker.setAttribute("aria-hidden", isOpen ? "false" : "true");
        if (isOpen) {
          pickerSelected = "";
          if (weaponPickerAdd) {
            weaponPickerAdd.disabled = true;
          }
        }
      }

      function setRacePickerOpen(isOpen) {
        if (!racePicker) return;
        racePicker.classList.toggle("open", isOpen);
        racePicker.setAttribute("aria-hidden", isOpen ? "false" : "true");
        if (isOpen) {
          raceSelected = "";
          if (racePickerAdd) {
            racePickerAdd.disabled = true;
          }
        }
      }

      function createEquipmentItem(name) {
        return {
          id: `w_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,
          name,
        };
      }

      function normalizeEquipmentItems(items) {
        if (!Array.isArray(items)) return [];
        if (items.length === 0) return [];
        if (typeof items[0] === "string") {
          return items.map((name) => createEquipmentItem(name));
        }
        return items.map((item) => ({
          id: item.id || createEquipmentItem(item.name || "Weapon").id,
          name: item.name || "Weapon",
        }));
      }

      function getEquippedWeaponById(id) {
        return equipmentItems.find((item) => item.id === id) || null;
      }

      function handleEquipToggle(item) {
        const weapon = getWeaponData(item.name);
        if (!weapon) return;
        const isTwoHanded = weapon.properties.includes("Two-Handed");
        const isEquippedMain = item.id === equippedMainId;
        const isEquippedOff = item.id === equippedOffhandId;

        if (isEquippedMain || isEquippedOff) {
          if (isEquippedMain) {
            equippedMainId = "";
            equippedMainTwoHanded = false;
          } else {
            equippedOffhandId = "";
          }
          setEquipStatus("");
          renderEquipment();
          updateActiveWeaponLabel();
          scheduleSave();
          return;
        }

        if (isTwoHanded) {
          if (equippedMainId || equippedOffhandId) {
            setEquipStatus("Two-handed weapons require both hands.");
            return;
          }
          equippedMainId = item.id;
          equippedOffhandId = "";
          equippedMainTwoHanded = true;
          activeWeaponName = item.name;
          setEquipStatus("");
          renderEquipment();
          updateActiveWeaponLabel();
          scheduleSave();
          return;
        }

        if (!equippedMainId) {
          equippedMainId = item.id;
          equippedMainTwoHanded = false;
          activeWeaponName = item.name;
          setEquipStatus("");
          renderEquipment();
          updateActiveWeaponLabel();
          scheduleSave();
          return;
        }

        if (equippedMainTwoHanded) {
          setEquipStatus("You can't equip another weapon while using two hands.");
          return;
        }

        const mainWeapon = getEquippedWeaponById(equippedMainId);
        const mainWeaponData = mainWeapon ? getWeaponData(mainWeapon.name) : null;
        const mainTwoHanded = mainWeaponData?.properties.includes("Two-Handed");
        if (mainTwoHanded) {
          setEquipStatus("You can't equip an offhand weapon while a two-handed weapon is equipped.");
          return;
        }

        if (!equippedOffhandId) {
          const mainIsLight = mainWeaponData?.properties.includes("Light");
          const offIsLight = weapon.properties.includes("Light");
          if (!mainIsLight || !offIsLight) {
            setEquipStatus("Offhand requires a Light weapon (unless you have a feature).");
            return;
          }
          equippedOffhandId = item.id;
          setEquipStatus("");
          renderEquipment();
          updateActiveWeaponLabel();
          scheduleSave();
          return;
        }

        setEquipStatus("You already have two weapons equipped.");
      }

      function handleTwoHandToggle(item) {
        if (item.id !== equippedMainId) {
          setEquipStatus("Two Hands only applies to the equipped main weapon.");
          return;
        }
        const weapon = getWeaponData(item.name);
        if (!weapon || !isVersatileWeapon(weapon)) return;
        if (equippedOffhandId) {
          setEquipStatus("You can't use two hands while an offhand weapon is equipped.");
          return;
        }
        equippedMainTwoHanded = !equippedMainTwoHanded;
        setEquipStatus("");
        renderEquipment();
        updateActiveWeaponLabel();
        scheduleSave();
      }

      function buildWeaponPickerList(filterText = "") {
        if (!weaponPickerList) return;
        const filter = filterText.trim().toLowerCase();
        weaponPickerList.innerHTML = "";

        const categoryOrder = [
          "Simple Melee Weapons",
          "Simple Ranged Weapons",
          "Martial Melee Weapons",
          "Martial Ranged Weapons",
        ];

        categoryOrder.forEach((category) => {
          const weapons = weaponTable
            .filter((weapon) => weapon.category === category)
            .filter((weapon) => weapon.name.toLowerCase().includes(filter))
            .sort((a, b) => a.name.localeCompare(b.name));

          if (!weapons.length) return;

          const header = document.createElement("div");
          header.className = "weapon-category";
          header.textContent = category;
          weaponPickerList.appendChild(header);

          const list = document.createElement("div");
          list.className = "weapon-list";
          weapons.forEach((weapon) => {
            const option = document.createElement("div");
            option.className = "weapon-option";
            if (weapon.name === pickerSelected) {
              option.classList.add("selected");
            }
            option.addEventListener("click", () => {
              pickerSelected = weapon.name;
              if (weaponPickerAdd) {
                weaponPickerAdd.disabled = false;
              }
              buildWeaponPickerList(weaponSearch?.value || "");
            });
            const name = document.createElement("strong");
            name.textContent = weapon.name;
            const meta = document.createElement("span");
            meta.textContent = `${weapon.damage} • ${weapon.properties === "—" ? "No properties" : weapon.properties}`;
            option.appendChild(name);
            option.appendChild(meta);
            list.appendChild(option);
          });

          weaponPickerList.appendChild(list);
        });
      }

      function buildRacePickerList(filterText = "") {
        if (!racePickerList) return;
        const filter = filterText.trim().toLowerCase();
        racePickerList.innerHTML = "";

        const races = raceList
          .filter((race) => race.toLowerCase().includes(filter))
          .sort((a, b) => a.localeCompare(b));

        const list = document.createElement("div");
        list.className = "weapon-list";
        races.forEach((race) => {
          const option = document.createElement("div");
          option.className = "weapon-option";
          if (race === raceSelected) {
            option.classList.add("selected");
          }
          option.addEventListener("click", () => {
            raceSelected = race;
            if (racePickerAdd) {
              racePickerAdd.disabled = false;
            }
            buildRacePickerList(raceSearch?.value || "");
          });
          const name = document.createElement("strong");
          name.textContent = race;
          option.appendChild(name);
          list.appendChild(option);
        });

        racePickerList.appendChild(list);
      }

      function initEquipmentWeapons() {
        if (addWeaponBtn) {
          addWeaponBtn.addEventListener("click", () => {
            setPickerOpen(true);
            buildWeaponPickerList(weaponSearch?.value || "");
          });
        }
        if (weaponSearch) {
          weaponSearch.addEventListener("input", () => {
            buildWeaponPickerList(weaponSearch.value);
          });
        }
        if (weaponPickerAdd) {
          weaponPickerAdd.addEventListener("click", () => {
            if (!pickerSelected) return;
            equipmentItems = [...equipmentItems, createEquipmentItem(pickerSelected)];
            activeWeaponName = pickerSelected;
            updateActiveWeaponLabel();
            renderEquipment();
            scheduleSave();
            setPickerOpen(false);
          });
        }
        if (weaponPickerClose) {
          weaponPickerClose.addEventListener("click", (event) => {
            event.stopPropagation();
            setPickerOpen(false);
          });
        }
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            setPickerOpen(false);
          }
        });
        buildWeaponPickerList("");
        updateActiveWeaponLabel();
      }

      function initRacePicker() {
        if (raceInput) {
          const openPicker = () => {
            setRacePickerOpen(true);
            if (raceInput.value && raceList.includes(raceInput.value)) {
              raceSelected = raceInput.value;
              if (racePickerAdd) {
                racePickerAdd.disabled = false;
              }
            }
            buildRacePickerList(raceSearch?.value || "");
          };
          raceInput.addEventListener("click", openPicker);
          raceInput.addEventListener("focus", openPicker);
        }
        if (raceSearch) {
          raceSearch.addEventListener("input", () => {
            buildRacePickerList(raceSearch.value);
          });
        }
        if (racePickerAdd) {
          racePickerAdd.addEventListener("click", () => {
            if (!raceSelected || !raceInput) return;
            raceInput.value = raceSelected;
            scheduleSave();
            setRacePickerOpen(false);
          });
        }
        if (racePickerClose) {
          racePickerClose.addEventListener("click", (event) => {
            event.stopPropagation();
            setRacePickerOpen(false);
          });
        }
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            setRacePickerOpen(false);
          }
        });
        buildRacePickerList("");
      }

      function scheduleSave() {
        if (isRemoteUpdate) return;
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(async () => {
          const payload = {};
          for (const el of fieldEls) {
            payload[el.id] = getFieldValue(el);
          }
          payload.equipmentItems = equipmentItems.slice();
          payload.equippedMainId = equippedMainId;
          payload.equippedOffhandId = equippedOffhandId;
          payload.equippedMainTwoHanded = equippedMainTwoHanded;
          try {
            await setDoc(sheetRef, payload, { merge: true });
        } catch (error) {
          console.error("Failed to save sheet", error);
        }
        }, 300);
      }

      function renderRoll(data) {
        if (!data) {
          resultEl.textContent = "No rolls yet.";
          return;
        }
        resultEl.innerHTML = "";
        const who = data.by || "someone";
        const when = data.at ? new Date(data.at.seconds * 1000) : null;
        const time = when
          ? when.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" })
          : "now";
        if (Array.isArray(data.parts)) {
          const header = document.createElement("div");
          header.textContent = `${data.label} (by ${who} at ${time})`;
          resultEl.appendChild(header);
          data.parts.forEach((part) => {
            const line = document.createElement("div");
            line.className = "roll-line";
            const left = document.createElement("span");
            const detail = part.detail ? ` (${part.detail})` : "";
            left.textContent = `${part.label}${detail}`;
            const right = document.createElement("span");
            right.textContent = part.value >= 0 ? `+${part.value}` : `${part.value}`;
            line.appendChild(left);
            line.appendChild(right);
            resultEl.appendChild(line);
          });
          const total = document.createElement("div");
          total.className = "roll-total";
          total.textContent = `Total: ${data.value}`;
          resultEl.appendChild(total);
          return;
        }
        if (data.roll !== undefined && data.mod !== undefined) {
          const header = document.createElement("div");
          header.textContent = `${data.label} (by ${who} at ${time})`;
          resultEl.appendChild(header);
          const line = document.createElement("div");
          line.className = "roll-line";
          line.textContent = `d20: ${data.roll} ${data.mod >= 0 ? "+" : ""}${data.mod}`;
          resultEl.appendChild(line);
          const total = document.createElement("div");
          total.className = "roll-total";
          total.textContent = `Total: ${data.value}`;
          resultEl.appendChild(total);
          return;
        }
        resultEl.textContent = `Last roll: ${data.value} (by ${who} at ${time})`;
      }

      onSnapshot(rollRef, (snap) => {
        renderRoll(snap.data());
      });

      onSnapshot(sheetRef, (snap) => {
        const data = snap.data();
        if (!data) return;
        isRemoteUpdate = true;
        fieldEls.forEach((el) => {
          applyFieldValue(el, data[el.id]);
        });
        if (Array.isArray(data.equipmentItems)) {
          equipmentItems = normalizeEquipmentItems(data.equipmentItems);
          equippedMainId = data.equippedMainId || "";
          equippedOffhandId = data.equippedOffhandId || "";
          equippedMainTwoHanded = Boolean(data.equippedMainTwoHanded);
          if (!equipmentItems.some((item) => item.id === equippedMainId)) {
            equippedMainId = "";
          }
          if (!equipmentItems.some((item) => item.id === equippedOffhandId)) {
            equippedOffhandId = "";
          }
          if (!equippedMainId) {
            equippedMainTwoHanded = false;
          } else {
            const mainItem = getEquippedWeaponById(equippedMainId);
            const mainWeapon = mainItem ? getWeaponData(mainItem.name) : null;
            if (!isVersatileWeapon(mainWeapon)) {
              equippedMainTwoHanded = Boolean(mainWeapon?.properties.includes("Two-Handed"));
            }
          }
          if (!equipmentItems.some((item) => item.name === activeWeaponName)) {
            activeWeaponName = equipmentItems[0]?.name || "";
          }
          updateActiveWeaponLabel();
          renderEquipment();
        }
        recalcDerived();
        isRemoteUpdate = false;
      });

      fieldEls.forEach((el) => {
        const evt = el.type === "checkbox" ? "change" : "input";
        el.addEventListener(evt, scheduleSave);
      });
      Object.values(abilityScores).forEach((el) => el?.addEventListener("input", recalcDerived));
      levelEl?.addEventListener("input", recalcDerived);
      document.querySelectorAll(".list-item input[type='checkbox']").forEach((el) =>
        el.addEventListener("change", recalcDerived)
      );
      recalcDerived();
      initEquipmentWeapons();
      initRacePicker();
      renderEquipment();

      rollBtn.addEventListener("click", async () => {
        const value = Math.floor(Math.random() * 20) + 1;
        resultEl.textContent = `Rolling... (${value})`;
        try {
          await setDoc(rollRef, {
            value,
            by: "anonymous",
            at: serverTimestamp(),
          });
        } catch (error) {
          resultEl.textContent = "Failed to roll. Check Firestore permissions.";
          console.error(error);
        }
      });

      function rollD20WithParts(parts, label) {
        const roll = Math.floor(Math.random() * 20) + 1;
        const total = parts.reduce((sum, part) => sum + part.value, roll);
        const localData = {
          roll,
          value: total,
          label,
          parts: [
            { label: "d20", value: roll },
            ...parts,
          ],
          by: "you",
          at: { seconds: Math.floor(Date.now() / 1000) },
        };
        renderRoll(localData);
        return setDoc(rollRef, {
          roll,
          value: total,
          label,
          parts: [
            { label: "d20", value: roll },
            ...parts,
          ],
          by: "anonymous",
          at: serverTimestamp(),
        }).catch((error) => {
          console.error("Failed to save roll", error);
        });
      }

      function setupRollables() {
        function bindKey(el, handler) {
          el.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              handler();
            }
          });
        }

        saveRows.forEach((row) => {
          const ability = row.dataset.ability;
          const label = row.querySelector("span");
          const checkbox = row.querySelector("input[type='checkbox']");
          const name = label?.textContent || `${ability.toUpperCase()} Save`;
          if (label) {
            label.classList.add("rollable");
            label.setAttribute("role", "button");
            label.setAttribute("tabindex", "0");
            const handler = () => {
              const base = computeAbilityMod(toNumber(abilityScores[ability]?.value));
              const mod = base + (checkbox?.checked ? toNumber(proficiencyBonusEl?.value) : 0);
              const parts = [{ label: `${ability.toUpperCase()} Mod`, value: base }];
              if (checkbox?.checked) {
                parts.push({ label: "Proficiency", value: toNumber(proficiencyBonusEl?.value) });
              }
              rollD20WithParts(parts, `${name} Save`);
            };
            label.addEventListener("click", handler);
            bindKey(label, handler);
          }
        });

        skillRows.forEach((row) => {
          const ability = row.dataset.ability;
          const label = row.querySelector("span");
          const checkbox = row.querySelector("input[type='checkbox']");
          const name = label?.textContent || "Skill Check";
          if (label) {
            label.classList.add("rollable");
            label.setAttribute("role", "button");
            label.setAttribute("tabindex", "0");
            const handler = () => {
              const base = computeAbilityMod(toNumber(abilityScores[ability]?.value));
              const mod = base + (checkbox?.checked ? toNumber(proficiencyBonusEl?.value) : 0);
              const parts = [{ label: `${ability.toUpperCase()} Mod`, value: base }];
              if (checkbox?.checked) {
                parts.push({ label: "Proficiency", value: toNumber(proficiencyBonusEl?.value) });
              }
              rollD20WithParts(parts, `${name} Check`);
            };
            label.addEventListener("click", handler);
            bindKey(label, handler);
          }
        });
      }

      function setupAttackRoll() {
        if (!attackRollBtn) return;
        attackRollBtn.addEventListener("click", (event) => {
          event.preventDefault();
          try {
            rollD20WithParts([], "Hit Roll");
          } catch (error) {
            console.error("Failed to roll attack", error);
          }
        });
      }

      function openItemPanel(name) {
        if (!itemPanel || !itemPanelTitle || !itemPanelBody) return;
        const weapon = getWeaponData(name);
        if (!weapon) return;
        const useTwoHands =
          weapon.name === getEquippedWeaponById(equippedMainId)?.name && equippedMainTwoHanded;
        const damageValue = useTwoHands
          ? `${getWeaponDamageDie(weapon, true)} ${weapon.damage.split(" ").slice(1).join(" ")}`
          : weapon.damage;
        const [dice, ...typeParts] = (damageValue || "").split(" ");
        const damageType = typeParts.join(" ");
        const ability = getWeaponAttackAbility(weapon);
        const abilityLabel =
          ability === "finesse" ? "Finesse (STR/DEX)" : ability.toUpperCase();
        const rangeMatch = weapon.properties.match(/Range\\s*([0-9/]+)/i);
        const rangeValue = rangeMatch ? rangeMatch[1] : null;
        itemPanelTitle.textContent = weapon.name;
        itemPanelBody.innerHTML = "";
        const rows = [
          ["Category", weapon.category.replace(" Weapons", "")],
          ["Type", weapon.category.includes("Ranged") ? "Ranged" : "Melee"],
          ["Damage", dice || "—"],
          ["Damage Type", damageType || "—"],
          ["Attack Ability", abilityLabel],
          ["Properties", weapon.properties === "—" ? "None" : weapon.properties],
          ["Mastery", weapon.mastery || "—"],
          ["Weight", weapon.weight || "—"],
          ["Cost", weapon.cost || "—"],
        ];
        if (rangeValue) {
          rows.splice(4, 0, ["Range", rangeValue]);
        }
        rows.forEach(([label, value]) => {
          const row = document.createElement("div");
          row.className = "item-row";
          const strong = document.createElement("strong");
          strong.textContent = label;
          const val = document.createElement("div");
          val.textContent = value;
          val.className = "item-tooltip";
          val.setAttribute("data-tooltip", getItemTooltip(label, value, weapon));
          row.appendChild(strong);
          row.appendChild(val);
          itemPanelBody.appendChild(row);
        });
        itemPanel.classList.add("open");
        itemPanel.setAttribute("aria-hidden", "false");
      }

      function setupItemPanel() {
        if (!itemPanel || !itemPanelClose) return;
        itemPanelClose.addEventListener("click", (event) => {
          event.stopPropagation();
          itemPanel.classList.remove("open");
          itemPanel.setAttribute("aria-hidden", "true");
        });
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            itemPanel.classList.remove("open");
            itemPanel.setAttribute("aria-hidden", "true");
          }
        });
      }

      setupRollables();
      setupAttackRoll();
      setupItemPanel();
      console.log("Firebase initialized", app.name);
    </script>
  </body>
</html>
